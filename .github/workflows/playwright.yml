name: Playwright Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: todoapp
          MYSQL_USER: todouser
          MYSQL_PASSWORD: todopassword
        ports:
          - 3309:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -prootpassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: playwright/package-lock.json

      - name: Install backend dependencies
        working-directory: ./todo-app-backend
        run: mvn clean install -DskipTests

      - name: Install frontend dependencies
        working-directory: ./todo-app-frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./todo-app-frontend
        run: npm run build

      - name: Start backend
        working-directory: ./todo-app-backend
        run: |
          nohup mvn spring-boot:run \
            -Dspring-boot.run.arguments="--spring.datasource.url=jdbc:mysql://localhost:3309/todoapp?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC --spring.datasource.username=root --spring.datasource.password=rootpassword" \
            > backend.log 2>&1 &
          echo $! > backend.pid
          # バックエンドの起動を待つ
          timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health 2>/dev/null; do sleep 2; done' || true
          sleep 10

      - name: Start frontend
        working-directory: ./todo-app-frontend
        run: |
          npx serve -s dist -l 80 > frontend.log 2>&1 &
          echo $! > frontend.pid
          # フロントエンドの起動を待つ
          timeout 30 bash -c 'until curl -f http://localhost 2>/dev/null; do sleep 2; done' || true
          sleep 5

      - name: Install Playwright dependencies
        working-directory: ./playwright
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./playwright
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        working-directory: ./playwright
        run: npm test
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright/playwright-report/
          retention-days: 30

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: playwright/screenshots/
          retention-days: 30

      - name: Upload test-results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: playwright/test-results/
          retention-days: 30

      - name: Show backend logs on failure
        if: failure()
        working-directory: ./todo-app-backend
        run: |
          echo "=== Backend Logs ==="
          cat backend.log || echo "No backend logs found"

      - name: Show frontend logs on failure
        if: failure()
        working-directory: ./todo-app-frontend
        run: |
          echo "=== Frontend Logs ==="
          cat frontend.log || echo "No frontend logs found"
