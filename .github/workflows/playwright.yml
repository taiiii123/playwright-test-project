name: Playwright Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: todoapp
          MYSQL_USER: todouser
          MYSQL_PASSWORD: todopassword
        ports:
          - 3309:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -prootpassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: playwright/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Create backend .env file
        working-directory: ./todo-app-backend
        run: |
          cat > .env << EOF
          SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3309/todoapp?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
          SPRING_DATASOURCE_USERNAME=root
          SPRING_DATASOURCE_PASSWORD=rootpassword
          JWT_SECRET=mySecretKey12345678901234567890123456789012
          JWT_EXPIRATION=86400000
          EOF

      - name: Create frontend .env file
        working-directory: ./todo-app-frontend
        run: |
          cat > .env << EOF
          VITE_API_BASE_URL=http://localhost:8080/api
          EOF

      - name: Install backend dependencies
        working-directory: ./todo-app-backend
        run: mvn clean install -DskipTests

      - name: Install frontend dependencies
        working-directory: ./todo-app-frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./todo-app-frontend
        run: npm run build

      - name: Start backend
        working-directory: ./todo-app-backend
        run: |
          nohup mvn spring-boot:run > backend.log 2>&1 &
          echo $! > backend.pid
          # バックエンドの起動を待つ
          echo "Waiting for backend to start..."
          for i in {1..60}; do
            if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
              echo "Backend is ready!"
              break
            fi
            sleep 2
          done
          sleep 5

      - name: Start frontend
        working-directory: ./todo-app-frontend
        run: |
          npx serve -s dist -l 3000 > frontend.log 2>&1 &
          echo $! > frontend.pid
          # フロントエンドの起動を待つ
          echo "Waiting for frontend to start..."
          for i in {1..30}; do
            if curl -f http://localhost:3000 2>/dev/null; then
              echo "Frontend is ready!"
              break
            fi
            sleep 2
          done
          sleep 3

      - name: Create Playwright .env file
        working-directory: ./playwright
        run: |
          cat > .env << EOF
          BASE_URL=http://localhost:3000
          DB_HOST=localhost
          DB_USER=root
          DB_PASSWORD=rootpassword
          DB_NAME=todoapp
          DB_PORT=3309
          SQL_PATH=tests/data/sql
          EOF

      - name: Install Playwright dependencies
        working-directory: ./playwright
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./playwright
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        working-directory: ./playwright
        run: npm test
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright/playwright-report/
          retention-days: 30

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: playwright/screenshots/
          retention-days: 30

      - name: Upload test-results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: playwright/test-results/
          retention-days: 30

      - name: Show backend logs on failure
        if: failure()
        working-directory: ./todo-app-backend
        run: |
          echo "=== Backend Logs ==="
          cat backend.log || echo "No backend logs found"

      - name: Show frontend logs on failure
        if: failure()
        working-directory: ./todo-app-frontend
        run: |
          echo "=== Frontend Logs ==="
          cat frontend.log || echo "No frontend logs found"
